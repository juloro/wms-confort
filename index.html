<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS Confort v5.1 (Picking Flexible)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,.05); }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-icon { font-size: 40px; }
        .dashboard-card-value { font-size: 2.25rem; }
        .table-responsive { max-height: 75vh; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #0d6efd; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .btn-icon { background: none; border: none; padding: 0.25rem 0.5rem; vertical-align: middle; cursor: pointer; }
        .nav-link { transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; padding-bottom: 0.5rem; cursor:pointer; }
        .nav-link:hover, .nav-link.active { border-bottom-color: #0d6efd; color: #0d6efd !important; }
        .nav-link.active { font-weight: 600; }
        .badge-estado { font-size: 0.8rem; padding: 0.4em 0.7em; }
        .badge-estado.PENDIENTE { background-color: #ffc107 !important; color: #343a40 !important; }
        .badge-estado.PICKEADO { background-color: #198754 !important; color: #fff !important; }
        .badge-estado.DESPACHADO { background-color: #0d6efd !important; color: #fff !important; }
        .badge-estado.INCIDENCIA { background-color: #dc3545 !important; color: #fff !important; }
        .badge-estado.CANCELADO { background-color: #6c757d !important; color: #fff !important; }
        .footer { padding: 1rem 0; background-color: #e9ecef; color: #6c757d; font-size: 0.9rem; }
        .autocomplete-container { position: relative; }
        .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 1055; border: 1px solid rgba(0,0,0,.15); max-height: 200px; overflow-y: auto; background-color: #fff; }
        .autocomplete-item { display: block; width: 100%; padding: .25rem 1rem; clear: both; font-weight: 400; color: #212529; text-align: inherit; white-space: nowrap; border: 0; }
        .autocomplete-item:hover { background-color: #e9ecef; cursor: pointer; }
        
        #dashboard { background-image: url('https://images4.imagebam.com/5d/52/54/ME14MBK7_o.png'); background-size: cover; background-position: center; border-radius: .5rem; padding: 1.5rem; }
        #dashboard .card { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px); }
        #auth-container { background-image: url('https://images4.imagebam.com/5d/52/54/ME14MBK7_o.png'); background-size: cover; background-position: center; }
        #auth-container > div { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); }

        /* Mapa de Ubicaciones */
        .map-container { display: grid; grid-template-columns: 1fr 0.5fr 1fr 1fr 0.5fr 1fr 1fr 0.5fr 1fr 0.5fr 1fr; gap: 5px; background-color: #e9ecef; padding: 10px; border-radius: .5rem; }
        .map-block, .map-aisle, .map-header, .map-module { padding: 8px; text-align: center; font-size: 0.8rem; font-weight: 600; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .map-header { background-color: #6c757d; color: white; }
        .map-block { background-color: #adb5bd; color: #ffffff; cursor: pointer; transition: transform 0.2s; user-select: none; }
        .map-block:hover { transform: scale(1.05); z-index: 10; }
        .map-module { display: flex; gap: 3px; }
        .map-location-cell { flex-grow: 1; padding: 4px 2px; font-size: 0.7rem; border-radius: 3px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .map-block-green { background-color: #198754; }
        .map-block-yellow { background-color: #ffc107; color: #000; }
        .map-block-red { background-color: #dc3545; }
        .map-block-empty { background-color: #ffffff; color: #6c757d; border: 1px dashed #ced4da; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p id="loadingText" class="mt-2 fw-bold">Cargando...</p>
        </div>
    </div>

    <div id="auth-container" class="loading-overlay">
        <div class="text-center p-5 rounded shadow-lg">
            <img src="https://images4.imagebam.com/cd/2e/40/ME14MAX8_o.png" alt="Logo" style="height: 112px;" class="mb-4">
            <p class="mb-4 lead">Conéctese con Google para continuar.</p>
            <button id="authorize_button" class="btn btn-primary btn-lg" disabled>Conectar con Google</button>
        </div>
    </div>
    
    <div id="modal-container"></div>

    <nav id="mainNavbar" class="navbar navbar-expand-lg navbar-light sticky-top d-none">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="https://images4.imagebam.com/cd/2e/40/ME14MAX8_o.png" alt="Logo" style="height: 75px;"></a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" data-view="dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="tareas">Tareas</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="ordenes">Órdenes</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="productos">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="movimientos">Movimientos</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="ubicaciones">Ubicaciones</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="remitos">Remitos</a></li>
                    <li class="nav-item"><a class="nav-link" data-view="controles">Controles</a></li>
                </ul>
                <button id="refresh_button" class="btn btn-outline-primary me-2"><span class="material-icons align-middle">refresh</span></button>
                <button id="signout_button" class="btn btn-outline-secondary">Desconectar</button>
            </div>
        </div>
    </nav>

    <main id="mainContent" class="container-fluid mt-4 d-none">
        <div id="dashboard" class="view active"></div>
        <div id="tareas" class="view"></div>
        <div id="ordenes" class="view"></div>
        <div id="productos" class="view"></div>
        <div id="movimientos" class="view"></div>
        <div id="ubicaciones" class="view"></div>
        <div id="remitos" class="view"></div>
        <div id="controles" class="view"></div>
    </main>

    <footer id="mainFooter" class="footer mt-auto d-none">
        <div class="container d-flex justify-content-between">
            <span>Created by Julian Orozco | Powered by Gemini</span>
            <span class="text-muted">v5.1 (Picking Flexible) - 2026</span>
        </div>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script type="text/javascript">
    (function() {
        'use strict';
        
        const CONFIG = {
            CLIENT_ID: '87731666752-orcgmhd0e19r205s9d97c4ak3rkvhb41.apps.googleusercontent.com',
            SPREADSHEET_ID: '17kxD1P_xRlQEZ6LP7YTJ6GTjpfPEuxVYnU0u3PxahYY',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets',
        };

        const CONSTANTS = {
            SHEET_NAMES: { PRODUCTS: 'PRODUCTOS', MOVEMENTS: 'MOVIMIENTOS', ORDERS: 'ORDENES', CONTROLS: 'Controles', ENTRADAS_SALIDAS: 'ENTRADAS_SALIDAS'},
            RANGES: { productos: 'PRODUCTOS!A2:C', movimientos: 'MOVIMIENTOS!A2:F', ubicaciones: 'UBICACIONES!A2:A', ordenes: 'ORDENES!A2:I', controles: 'Controles!A2:J', entradasSalidas: 'ENTRADAS_SALIDAS!A2:H' },
            STATUS: { PENDING: 'PENDIENTE', PICKED: 'PICKEADO', SHIPPED: 'DESPACHADO', INCIDENCE: 'INCIDENCIA', CANCELLED: 'CANCELADO' },
            MOVEMENT_TYPE: { INGRESS: 'INGRESO', EGRESS: 'EGRESO', ADJUSTMENT: 'AJUSTE', MOVE: 'MOVER', PICKING: 'PICKING' },
            IDS: { PICKING_MODAL: 'pickingModal', NEW_MOVEMENT_MODAL: 'newMovementModal' },
            DEFAULT_INGRESS_LOCATION: 'Z00',
            CONTROL_ID_PREFIX: 'CTRL-',
            PRODUCTOS_SHEET_ID: 898730711, 
        };

        let tokenClient, gapiInited = false, gisInited = false, domReady = false;
        let fullData = { productos: [], movimientos: [], ubicaciones: [], ordenes: [], controles: [], entradasSalidas: [], stockTotal: new Map(), stockPorUbicacion: new Map() };
        let virtualTasks = [], validLocations = new Set(), locationsWithStock = new Set(), lastControlDates = new Map(), activeModals = {};
        let DOM = {};

        // --- INICIALIZACIÓN ---
        window.gapiLoaded = () => gapi.load('client', async () => {
            await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
            gapiInited = true; maybeEnableAuthButton();
        });

        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CONFIG.CLIENT_ID, scope: CONFIG.SCOPES, callback: (resp) => { if (!resp.error) { showUI(true); loadInitialData(); } } });
            gisInited = true; maybeEnableAuthButton();
        };

        function maybeEnableAuthButton() { if (gapiInited && gisInited && domReady) DOM.authorizeButton.disabled = false; }

        async function loadInitialData() {
            showLoading(true, 'Cargando datos...');
            try {
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({ spreadsheetId: CONFIG.SPREADSHEET_ID, ranges: Object.values(CONSTANTS.RANGES) });
                const valueRanges = response.result.valueRanges;
                Object.keys(CONSTANTS.RANGES).forEach((name, index) => fullData[name] = valueRanges[index]?.values || []);
                processAndCalculateStock();
                processControlDates();
                renderAllViews();
            } catch (err) { console.error(err); } finally { showLoading(false); }
        }

        function processAndCalculateStock() {
            fullData.stockTotal.clear(); fullData.stockPorUbicacion.clear(); locationsWithStock.clear();
            fullData.movimientos.forEach(mov => {
                const id = String(mov[0] || '').trim(), loc = String(mov[3] || 'S/U').trim(), qty = parseInt(mov[2], 10) || 0;
                if (!id) return;
                fullData.stockTotal.set(id, (fullData.stockTotal.get(id) || 0) + qty);
                if (!fullData.stockPorUbicacion.has(id)) fullData.stockPorUbicacion.set(id, new Map());
                const locMap = fullData.stockPorUbicacion.get(id);
                locMap.set(loc, (locMap.get(loc) || 0) + qty);
                if (qty > 0) locationsWithStock.add(loc);
            });
            validLocations = new Set(fullData.ubicaciones.flat().map(l => String(l || '').trim()).filter(Boolean));
        }

        function processControlDates() {
            lastControlDates.clear();
            fullData.controles.forEach(c => {
                const date = new Date(c[1]?.split(' ')[0].split('/').reverse().join('-'));
                if (date && (!lastControlDates.has(c[5]) || date > lastControlDates.get(c[5]))) lastControlDates.set(c[5], date);
            });
        }

        // --- RENDERIZADO ---
        function renderAllViews() {
            renderDashboardView();
            renderTasksView();
            renderOrdersView();
            renderLocationsView();
            // ... otras vistas simplificadas por espacio
        }

        function renderDashboardView() {
            const container = document.getElementById('dashboard');
            const p = fullData.ordenes.filter(o => o[6] === CONSTANTS.STATUS.PENDING).length;
            container.innerHTML = `<h2>Dashboard</h2><div class="row"><div class="col-md-4"><div class="card p-3"><h5>Picking Pendiente</h5><h3>${p}</h3></div></div></div>`;
        }

        function renderTasksView() {
            generateVirtualTasks();
            const container = document.getElementById('tareas');
            container.innerHTML = `<div class="d-flex justify-content-between mb-4"><h2>Picking</h2><button class="btn btn-success" data-action="bulk-pick-tasks">Picking Masivo</button></div>
                <table class="table bg-white"><thead><tr><th>Producto</th><th>Cant</th><th>Ubicación</th><th>Acción</th></tr></thead>
                <tbody>${virtualTasks.map(t => `<tr><td>${t.nombre}</td><td>${t.totalQuantity}</td><td>${getBestLocationForProduct(t.idProducto) || 'S/U'}</td><td><button class="btn btn-sm btn-primary" data-action="handle-stage-click" data-product-id="${t.idProducto}" data-state="PENDIENTE">Pickear</button></td></tr>`).join('')}</tbody></table>`;
        }

        function renderOrdersView() {
            const container = document.getElementById('ordenes');
            container.innerHTML = `<h2>Órdenes</h2><table class="table bg-white"><thead><tr><th>ID</th><th>Producto</th><th>Estado</th></tr></thead>
                <tbody>${fullData.ordenes.map((o, i) => `<tr><td>${o[1]}</td><td>${o[2]}</td><td><span class="badge badge-estado ${o[6]}">${o[6]}</span></td></tr>`).join('')}</tbody></table>`;
        }

        function renderLocationsView() {
            document.getElementById('ubicaciones').innerHTML = `<div class="alert alert-info">Mapa de Ubicaciones (Visualización estándar v5.1)</div>`;
        }

        // --- LÓGICA DE PICKING ---
        function generateVirtualTasks() {
            const map = new Map();
            fullData.ordenes.filter(o => o[6] === CONSTANTS.STATUS.PENDING).forEach(o => {
                if (!map.has(o[3])) map.set(o[3], { idProducto: o[3], nombre: o[2], totalQuantity: 0, orders: [] });
                const t = map.get(o[3]); t.totalQuantity += parseInt(o[4]); t.orders.push({ idVenta: o[1], index: fullData.ordenes.indexOf(o) });
            });
            virtualTasks = Array.from(map.values());
        }

        function showPickingModal(productId) {
            const task = virtualTasks.find(t => t.idProducto === productId);
            const locs = fullData.stockPorUbicacion.get(productId);
            let body = '', footer = '';

            if (locs && locs.size > 0) {
                body = `<h6>Ubicaciones:</h6>` + [...locs.entries()].map(([l, s]) => `<div class="mb-2">${l}: ${s} <input type="number" class="picking-qty-input" data-location="${l}" data-max-stock="${s}" min="0"></div>`).join('');
                footer = `<button class="btn btn-primary" data-action="confirm-picking" data-product-id="${productId}">Confirmar</button>`;
            } else {
                body = `<div class="alert alert-warning">No hay stock disponible.</div>`;
                footer = `<button class="btn btn-warning" data-action="quick-ingress-and-pick" data-product-id="${productId}">Ingreso Rápido y Pick</button>
                          <button class="btn btn-danger" data-action="confirm-out-of-stock" data-product-id="${productId}">Marcar Falta</button>`;
            }

            const html = `<div class="modal fade" id="pickingModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Picking: ${task.nombre}</h5></div><div class="modal-body">${body}</div><div class="modal-footer">${footer}</div></div></div></div>`;
            createAndShowModal('pickingModal', html);
            document.getElementById('pickingModal').dataset.productId = productId;
        }

        async function quickIngressAndPick(productId) {
            const task = virtualTasks.find(t => t.idProducto === productId);
            const qty = task.totalQuantity, ts = getTimestamp(), loc = CONSTANTS.DEFAULT_INGRESS_LOCATION;
            if (!confirm(`Se ingresarán ${qty} unidades a ${loc} para completar el picking. ¿Continuar?`)) return;

            activeModals['pickingModal']?.hide(); showLoading(true, 'Procesando...');
            try {
                const movs = [[productId, task.nombre, qty, loc, CONSTANTS.MOVEMENT_TYPE.INGRESS, ts], [productId, task.nombre, -qty, loc, CONSTANTS.MOVEMENT_TYPE.PICKING, ts]];
                const updates = task.orders.map(o => ({ range: `ORDENES!G${o.index + 2}`, values: [[CONSTANTS.STATUS.PICKED]] }));
                await Promise.all([appendToSheet(CONSTANTS.RANGES.movimientos, movs), batchUpdateSheet(updates)]);
                await loadInitialData();
            } catch (err) { handleApiError(err); } finally { showLoading(false); }
        }

        async function bulkPickTasks() {
            if (!confirm(`¿Confirma el picking masivo de ${virtualTasks.length} tareas?\n\nNota: Los productos sin ubicación (S/U) se descontarán de ${CONSTANTS.DEFAULT_INGRESS_LOCATION}.`)) return;
            showLoading(true, 'Procesando masivo...');
            const movs = [], updates = [], ts = getTimestamp();
            virtualTasks.forEach(t => {
                const loc = getBestLocationForProduct(t.idProducto) || CONSTANTS.DEFAULT_INGRESS_LOCATION;
                movs.push([t.idProducto, t.nombre, -t.totalQuantity, loc, CONSTANTS.MOVEMENT_TYPE.PICKING, ts]);
                t.orders.forEach(o => updates.push({ range: `ORDENES!G${o.index + 2}`, values: [[CONSTANTS.STATUS.PICKED]] }));
            });
            try { await Promise.all([appendToSheet(CONSTANTS.RANGES.movimientos, movs), batchUpdateSheet(updates)]); await loadInitialData(); }
            catch (err) { handleApiError(err); } finally { showLoading(false); }
        }

        // --- UTILS ---
        const createAndShowModal = (id, html) => {
            DOM.modalContainer.innerHTML = ''; 
            const wrapper = document.createElement('div'); wrapper.innerHTML = html;
            const el = wrapper.firstElementChild;
            DOM.modalContainer.appendChild(el);
            const inst = new bootstrap.Modal(el);
            activeModals[id] = inst; inst.show();
            el.addEventListener('hidden.bs.modal', () => { delete activeModals[id]; el.remove(); }, { once: true });
        };

        const getBestLocationForProduct = (id) => {
            const m = fullData.stockPorUbicacion.get(id);
            if (!m) return null;
            return [...m.entries()].filter(e => e[1] > 0).sort((a,b) => b[1]-a[1])[0]?.[0];
        };

        function handleAction(e) {
            const t = e.target.closest('[data-action]'); if (!t) return;
            const a = t.dataset.action, d = t.dataset;
            const map = {
                'quick-ingress-and-pick': () => quickIngressAndPick(d.productId),
                'bulk-pick-tasks': bulkPickTasks,
                'handle-stage-click': () => handleStageClick(d.productId, d.state),
                'confirm-picking': () => confirmPicking(d.productId)
            };
            if (map[a]) map[a]();
        }

        function handleStageClick(id, state) { if (state === 'PENDIENTE') showPickingModal(id); }

        const showLoading = (s, t) => { DOM.loadingOverlay.classList.toggle('d-none', !s); DOM.loadingText.textContent = t; };
        const getTimestamp = () => new Date().toLocaleString('es-AR').replace(',', '');
        const appendToSheet = (r, v) => gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: CONFIG.SPREADSHEET_ID, range: r, valueInputOption: 'USER_ENTERED', resource: { values: v } });
        const batchUpdateSheet = (d) => gapi.client.sheets.spreadsheets.values.batchUpdate({ spreadsheetId: CONFIG.SPREADSHEET_ID, resource: { valueInputOption: 'USER_ENTERED', data: d } });

        document.addEventListener('DOMContentLoaded', () => {
            DOM = {
                authorizeButton: document.getElementById('authorize_button'), signoutButton: document.getElementById('signout_button'), refreshButton: document.getElementById('refresh_button'),
                loadingOverlay: document.getElementById('loadingOverlay'), loadingText: document.getElementById('loadingText'), authContainer: document.getElementById('auth-container'),
                mainNavbar: document.getElementById('mainNavbar'), mainContent: document.getElementById('mainContent'), mainFooter: document.getElementById('mainFooter'),
                modalContainer: document.getElementById('modal-container'), navContainer: document.querySelector('.navbar-nav')
            };
            domReady = true; maybeEnableAuthButton();
            document.body.addEventListener('click', handleAction);
            document.querySelector('.navbar-nav').addEventListener('click', (e) => {
                const link = e.target.closest('.nav-link');
                if (link) {
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.getElementById(link.dataset.view).classList.add('active');
                }
            });
        });

    })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
