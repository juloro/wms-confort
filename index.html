e     doc.rect(data.cell.x + data.cell.width / 2 - 2, data.cell.y + 2, 4, 4);
                    }
                }
            });

            addFooters(doc);
            doc.save(fileName);
        }
        
        function downloadProductsCSV() {
            const tableBody = document.getElementById('products-table');
            if (!tableBody) {
                return alert('Error: No se encontró la tabla de productos.');
            }

            const visibleRows = Array.from(tableBody.rows).filter(row => row.style.display !== 'none');

            if (visibleRows.length === 0) {
                return alert('No hay productos en la vista actual para descargar.');
            }

            const csvHeader = ['ID Producto', 'Nombre', 'Stock'];
            const csvRows = [csvHeader];

            visibleRows.forEach(row => {
                const id = row.cells[0]?.textContent.trim() || '';
                const name = row.cells[1]?.textContent.trim() || '';
                const stock = row.cells[3]?.textContent.trim() || '0';
                csvRows.push([id, name, stock]);
            });

            const escapeCSVField = (field) => {
                const str = String(field);
                if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            const csvContent = "data:text/csv;charset=utf-8," + csvRows.map(row => row.map(escapeCSVField).join(',')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "productos_filtrados.csv");
            document.body.appendChild(link);

            link.click();
            document.body.removeChild(link);
        }

        function downloadLocationDetailPDF(label, locationsStr) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const locations = locationsStr.split(',');
            const stockInGroup = new Map();
            for (const loc of locations) {
                fullData.stockPorUbicacion.forEach((locationsMap, productId) => {
                    if (locationsMap.has(loc)) {
                        const qty = locationsMap.get(loc);
                        if (qty > 0) {
                            const product = fullData.productos.find(p => p[0] === productId);
                            if (product) {
                                const currentStock = stockInGroup.get(productId) || { name: product[1], qty: 0 };
                                currentStock.qty += qty;
                                stockInGroup.set(productId, currentStock);
                            }
                        }
                    }
                });
            }

            const tableRows = [...stockInGroup.entries()]
                .sort((a, b) => a[1].name.localeCompare(b[1].name))
                .map(([id, data]) => [id, data.name, data.qty]);

            const datesInGroup = locations.map(loc => lastControlDates.get(loc)).filter(Boolean);
            let lastControlText = 'No se han registrado controles para esta ubicación o grupo.';
            if (datesInGroup.length > 0) {
                const mostRecentDate = new Date(Math.max(...datesInGroup));
                const diffDays = Math.ceil(Math.abs(new Date() - mostRecentDate) / (1000 * 60 * 60 * 24));
                lastControlText = `Último control: ${mostRecentDate.toLocaleDateString('es-AR')} (hace ${diffDays} días)`;
            }

            const addFooters = doc => {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(8);
                for (var i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text('Página ' + String(i) + ' de ' + String(pageCount), doc.internal.pageSize.width / 2, 287, { align: 'center' });
                }
            }

            const now = new Date();
            const formattedDate = now.toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }).replace(',', '');
            const fileName = `Detalle_Ubicacion_${label.replace(/[\/\\?%*:|"<>]/g, '-')}.pdf`;

            doc.setFontSize(20);
            doc.text(`Detalle de Ubicación: ${label}`, 14, 15);
            doc.setFontSize(10);
            doc.text(formattedDate, 14, 22);
            doc.setFontSize(12);
            doc.text(lastControlText, 14, 28);

            doc.autoTable({
                head: [['ID Producto', 'Nombre', 'Cantidad']],
                body: tableRows.length > 0 ? tableRows : [['No hay stock en esta ubicación.', '', '']],
                startY: 35,
                headStyles: { fillColor: [66, 73, 80] },
                theme: 'striped'
            });

            addFooters(doc);
            doc.save(fileName);
        }

        function downloadRemitoDetailPDF(remitoId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const data = processedRemitos.get(remitoId);
            if (!data) {
                return alert('Error: No se encontraron los datos del remito para generar el PDF.');
            }

            const tableRows = data.productos.map(p => [p.id, p.nombre, p.cantidad]);

            const addFooters = doc => {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(8);
                for (var i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text('Página ' + String(i) + ' de ' + String(pageCount), doc.internal.pageSize.width / 2, 287, { align: 'center' });
                }
            };
            
            const fileName = `Remito_${remitoId.replace(/[\/\\?%*:|"<>]/g, '-')}.pdf`;

            doc.setFontSize(20);
            doc.text('Detalle de Remito', 14, 22);
            doc.setFontSize(12);
            doc.text(`Número: ${remitoId}`, 14, 32);
            doc.setFontSize(10);
            doc.text(`Fecha: ${data.fecha}`, 14, 38);
            doc.text(`Tipo: ${data.tipo}`, 14, 43);
            doc.text(`Motivo: ${data.motivo}`, 14, 48);
            doc.text(`Origen/Destino: ${data.origen}`, 14, 53);
            doc.text(`Unidades Totales: ${data.totalUnidades}`, 14, 58);

            doc.autoTable({
                head: [['ID Producto', 'Nombre', 'Cantidad']],
                body: tableRows,
                startY: 65,
                headStyles: { fillColor: [66, 73, 80] }, 
                theme: 'striped'
            });

            addFooters(doc);
            doc.save(fileName);
        }

        function drawSingleLabel(doc, data, current, total) {
            const margin = 3;
            const maxWidth = 40 - (margin * 2);
            const centerX = 20;
            let y = margin + 5;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            const productNameLines = doc.splitTextToSize(data.productName, maxWidth);
            doc.text(productNameLines, centerX, y, { align: 'center' });
            y += (productNameLines.length * 3.5);

            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`${data.productSku}`, centerX, y, { align: 'center' });
            y += 4;
            
            const quantityText = `${current} de ${total}`;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(quantityText, centerX, y, { align: 'center' });
            y += 5;

            doc.setLineWidth(0.2);
            doc.line(margin, y, 40 - margin, y);
            y += 5;

            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            const customerNameLines = doc.splitTextToSize(data.customerName, maxWidth);
            doc.text(customerNameLines, centerX, y, { align: 'center' });
            y += (customerNameLines.length * 3.5) + 1;

            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(data.channel, centerX, y, { align: 'center' });
            y += 5;

            doc.line(margin, y, 40 - margin, y);
            y += 5;

            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.text(data.date, centerX, y, { align: 'center' });
            y += 4;

            if (data.orderNumber) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(data.orderNumber, centerX, y, { align: 'center' });
            }
        }

        function downloadOrderLabel(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [40, 60] });
            const totalQuantity = parseInt(data.quantity, 10) || 1;

            for (let i = 1; i <= totalQuantity; i++) {
                if (i > 1) doc.addPage();
                drawSingleLabel(doc, data, i, totalQuantity);
            }

            const fileName = `Etiqueta_${data.productSku}_${data.customerName.replace(/ /g,"_")}.pdf`;
            doc.save(fileName);
        }

        function bulkPrintLabels() {
            const tableBody = document.getElementById('orders-table');
            if (!tableBody) return;

            const visibleRows = Array.from(tableBody.rows).filter(row => row.style.display !== 'none');
            const ordersToPrint = [];

            visibleRows.forEach(row => {
                const orderIndex = parseInt(row.dataset.orderIndex, 10);
                const order = fullData.ordenes[orderIndex];
                if (order && (order[6] || '').toUpperCase() === CONSTANTS.STATUS.PICKED) {
                    ordersToPrint.push({
                        productName: order[2], productSku: order[3], quantity: order[4],
                        customerName: order[7] || '', channel: order[5], date: order[0], orderNumber: order[8] || ''
                    });
                }
            });

            if (ordersToPrint.length === 0) {
                return alert('No se encontraron órdenes en estado "PICKEADO" en la vista actual para imprimir etiquetas.');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [40, 60] });
            let isFirstLabel = true;

            ordersToPrint.forEach(orderData => {
                const totalQuantity = parseInt(orderData.quantity, 10) || 1;
                for (let i = 1; i <= totalQuantity; i++) {
                    if (!isFirstLabel) doc.addPage();
                    drawSingleLabel(doc, orderData, i, totalQuantity);
                    isFirstLabel = false;
                }
            });

            const now = new Date();
            const fileName = `Etiquetas_Masivas_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
            doc.save(fileName);
        }

        function bulkGenerateRemito() {
            const tableBody = document.getElementById('orders-table');
            if (!tableBody) return;

            const visibleRows = Array.from(tableBody.rows).filter(row => row.style.display !== 'none');
            const ordersForRemito = [];

            visibleRows.forEach(row => {
                const orderIndex = parseInt(row.dataset.orderIndex, 10);
                const order = fullData.ordenes[orderIndex];
                if (order && (order[6] || '').toUpperCase() === CONSTANTS.STATUS.PICKED) {
                    ordersForRemito.push(order);
                }
            });

            if (ordersForRemito.length === 0) {
                return alert('No se encontraron órdenes en estado "PICKEADO" en la vista actual para generar un remito.');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // -- Header --
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text("REMITO", 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Fecha de Emisión: ${getTimestamp()}`, 20, 30);

            doc.setFont('helvetica', 'bold');
            doc.text("Remitente:", 20, 40);
            doc.setFont('helvetica', 'normal');
            doc.text("CONFORT ANVE", 20, 45);
            doc.text("CENTRO INDUSTRIAL PANAMERICANA 36, GUAYAQUIL 3100", 20, 50);
            doc.text("TORTUGUITAS, BUENOS AIRES (CP 1667)", 20, 55);

            // -- Table --
            const tableColumn = ['ID Venta', 'Cliente', 'Producto', 'Cantidad'];
            const tableRows = [];
            ordersForRemito.forEach(order => {
                const rowData = [
                    order[1], 
                    order[7] || 'N/A', 
                    `${order[3]} - ${order[2]}`, 
                    order[4]
                ];
                tableRows.push(rowData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 65,
                theme: 'striped',
                headStyles: { fillColor: [60, 60, 60] }
            });

            // -- Footer Legend --
            const finalY = doc.autoTable.previous.finalY;
            const legend = "TODOS LOS ARTÍCULOS FUERON REVISADOS Y SE ENCUENTRAN EN BUENAS CONDICIONES DE EMBALAJE Y FUNCIONAMIENTO, SIN GOLPES NI ROTURAS";
            const splitLegend = doc.splitTextToSize(legend, 180);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.text(splitLegend, 15, finalY + 15);
            
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            for (var i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.text(`Página ${i} de ${pageCount}`, 105, 285, { align: 'center' });
            }

            const now = new Date();
            const fileName = `Remito_Masivo_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
            doc.save(fileName);
        }

        // --- 8. PUNTO DE ENTRADA DE LA APLICACIÓN ---
        
        document.addEventListener('DOMContentLoaded', () => {
            DOM = {
                authorizeButton: document.getElementById('authorize_button'),
                signoutButton: document.getElementById('signout_button'),
                refreshButton: document.getElementById('refresh_button'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                loadingText: document.getElementById('loadingText'),
                authContainer: document.getElementById('auth-container'),
                mainNavbar: document.getElementById('mainNavbar'),
                mainContent: document.getElementById('mainContent'),
                mainFooter: document.getElementById('mainFooter'),
                modalContainer: document.getElementById('modal-container'),
                navContainer: document.querySelector('.navbar-nav'),
                views: {
                    dashboard: document.getElementById('dashboard'),
                    tareas: document.getElementById('tareas'),
                    ordenes: document.getElementById('ordenes'),
                    productos: document.getElementById('productos'),
                    movimientos: document.getElementById('movimientos'),
                    ubicaciones: document.getElementById('ubicaciones'),
                    remitos: document.getElementById('remitos'),
                    controles: document.getElementById('controles'),
                }
            };
            
            domReady = true;
            initializeEventListeners();
            maybeEnableAuthButton();
        });

    })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
